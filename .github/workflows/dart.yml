name: Dartotsu Build Workflow 
on:
  push:
    branches: [main]
    tags:
      - 'v*'
      - 'v*-beta*'

env:
  FLUTTER_VERSION: '3.32.5'
  JAVA_VERSION: '17'
  CMAKE_VERSION: '3.18.1'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      should_build_android: ${{ steps.check.outputs.android }}
      should_build_windows: ${{ steps.check.outputs.windows }}
      should_build_linux: ${{ steps.check.outputs.linux }}
      should_build_ios: ${{ steps.check.outputs.ios }}
      should_build_macos: ${{ steps.check.outputs.macos }}
      is_release: ${{ steps.check.outputs.is_release }}
      is_beta: ${{ steps.check.outputs.is_beta }}
      is_clean: ${{ steps.check.outputs.is_clean }}
      version: ${{ steps.version.outputs.version }}
      discord_channel: ${{ steps.check.outputs.discord_channel }}
      ping_role: ${{ steps.check.outputs.ping_role }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check build triggers
        id: check
        env:
          STABLE_ROLE: ${{ secrets.DISCORD_STABLE_ROLE }}
          BETA_ROLE: ${{ secrets.DISCORD_BETA_ROLE }}
          ALPHA_ROLE: ${{ secrets.DISCORD_ALPHA_ROLE }}
          STABLE_CHANNEL: ${{ secrets.DISCORD_STABLE_CHANNEL }}
          ALPHA_CHANNEL: ${{ secrets.DISCORD_ALPHA_CHANNEL }}
        run: |
          MSG="${{ github.event.head_commit.message }}"
          IS_TAG=${{ startsWith(github.ref, 'refs/tags/') }}
          
          # Determine if it's a release/beta
          if [[ "$IS_TAG" == "true" ]]; then
            if [[ "${{ github.ref }}" == *"beta"* ]]; then
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "is_beta=true" >> $GITHUB_OUTPUT
              echo "discord_channel=$STABLE_CHANNEL" >> $GITHUB_OUTPUT
              echo "ping_role=<@&$BETA_ROLE>" >> $GITHUB_OUTPUT
            else
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "is_beta=false" >> $GITHUB_OUTPUT
              echo "discord_channel=$STABLE_CHANNEL" >> $GITHUB_OUTPUT
              echo "ping_role=<@&$STABLE_ROLE>" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_beta=false" >> $GITHUB_OUTPUT
            echo "discord_channel=$ALPHA_CHANNEL" >> $GITHUB_OUTPUT
            if [[ "$MSG" == *"[Ping]"* ]]; then
              echo "ping_role=<@&$ALPHA_ROLE>" >> $GITHUB_OUTPUT
            else
              echo "ping_role=noPing" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Check clean build
          [[ "$MSG" == *"[clean]"* ]] && echo "is_clean=true" >> $GITHUB_OUTPUT || echo "is_clean=false" >> $GITHUB_OUTPUT
          
          # Platform checks
          if [[ "$IS_TAG" == "true" ]] || [[ "$MSG" == *"[build.all]"* ]]; then
            echo "android=true" >> $GITHUB_OUTPUT
            echo "windows=true" >> $GITHUB_OUTPUT
            echo "linux=true" >> $GITHUB_OUTPUT
            echo "ios=true" >> $GITHUB_OUTPUT
            echo "macos=true" >> $GITHUB_OUTPUT
          else
            [[ "$MSG" == *"[build.apk]"* || "$MSG" == *"[build]"* ]] && echo "android=true" >> $GITHUB_OUTPUT || echo "android=false" >> $GITHUB_OUTPUT
            [[ "$MSG" == *"[build.windows]"* ]] && echo "windows=true" >> $GITHUB_OUTPUT || echo "windows=false" >> $GITHUB_OUTPUT
            [[ "$MSG" == *"[build.linux]"* || "$MSG" == *"[build]"* ]] && echo "linux=true" >> $GITHUB_OUTPUT || echo "linux=false" >> $GITHUB_OUTPUT
            [[ "$MSG" == *"[build.ios]"* ]] && echo "ios=true" >> $GITHUB_OUTPUT || echo "ios=false" >> $GITHUB_OUTPUT
            [[ "$MSG" == *"[build.macos]"* ]] && echo "macos=true" >> $GITHUB_OUTPUT || echo "macos=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build_android:
    needs: setup
    if: needs.setup.outputs.should_build_android == 'true'
    runs-on: ubuntu-latest
    outputs:
      apk_link: ${{ steps.upload_universal.outputs.web-content-link }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "oracle"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        if: needs.setup.outputs.is_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
            .dart_tool/
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Setup build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build
          mkdir -p /usr/local/lib/android/sdk/cmake/${{ env.CMAKE_VERSION }}/bin
          sudo ln -sf /usr/bin/ninja /usr/local/lib/android/sdk/cmake/${{ env.CMAKE_VERSION }}/bin/ninja

      - name: Setup signing
        env:
          KEYSTORE_BASE64: ${{ secrets.APK_SIGN }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/dartotsu.jks
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=dartotsu.jks
          EOF

      - name: Setup environment
        run: echo "SIMKL_SECRET=${{ secrets.SIMKL_SECRET }}" > .env

      - name: Build APKs
        run: |
          flutter clean
          flutter pub get
          flutter build apk --release --split-per-abi
          flutter build apk --release

      - name: Rename APKs
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=$(echo $file | sed 's/app-\(.*\)-release.apk/\1/')
            mv $file Dartotsu_Android_${abi}_${{ needs.setup.outputs.version }}.apk
          done
          mv app-release.apk Dartotsu_Android_universal_${{ needs.setup.outputs.version }}.apk

      - name: Upload to Google Drive
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build/app/outputs/flutter-apk/Dartotsu_Android_arm64-v8a_${{ needs.setup.outputs.version }}.apk
          upload-name: Dartotsu_Android_arm64-v8a.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload universal APK
        id: upload_universal
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build/app/outputs/flutter-apk/Dartotsu_Android_universal_${{ needs.setup.outputs.version }}.apk
          upload-name: Dartotsu.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload to GitHub Release
        if: needs.setup.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/*.apk
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}

  build_windows:
    needs: setup
    if: needs.setup.outputs.should_build_windows == 'true'
    runs-on: windows-latest
    outputs:
      installer_link: ${{ steps.upload.outputs.web-content-link }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        if: needs.setup.outputs.is_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Pub\Cache
            build
            .dart_tool
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1

      - name: Setup signing
        run: |
          mkdir $env:USERPROFILE\certs
          [System.IO.File]::WriteAllBytes("$env:USERPROFILE\certs\Dartotsu.pfx", [Convert]::FromBase64String("${{ secrets.PFX_FILE }}"))

      - name: Setup environment
        run: echo "SIMKL_SECRET=$env:{{ secrets.SIMKL_SECRET }}" > .env

      - name: Build
        run: |
          flutter config --enable-windows-desktop
          flutter clean
          flutter pub get
          
          $sdkBins = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Directory | 
                     Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } |  
                     Sort-Object Name -Descending | 
                     Select-Object -First 1
          $signtoolPath = Join-Path $sdkBins.FullName "x64\signtool.exe"
          
          dart run inno_bundle:build --sign-tool-params "`"$signtoolPath`" sign /fd sha256 /f `"C:\Users\runneradmin\certs\Dartotsu.pfx`" /p `"${{ secrets.PFX_PASSWORD }}`" /tr http://timestamp.digicert.com /td sha256 /v `$f" --release

      - name: Upload to Google Drive
        id: upload
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build\windows\x64\installer\Release\Dartotsu-x86_64-${{ needs.setup.outputs.version }}-Installer.exe
          upload-name: Dartotsu_windows.exe
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload to GitHub Release
        if: needs.setup.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: build\windows\x64\installer\Release\*.exe
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}

  build_linux:
    needs: setup
    if: needs.setup.outputs.should_build_linux == 'true'
    runs-on: ubuntu-latest
    outputs:
      zip_link: ${{ steps.upload.outputs.web-content-link }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        if: needs.setup.outputs.is_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build/
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev webkit2gtk-4.1 libmpv-dev pkg-config fuse

      - name: Setup environment
        run: echo "SIMKL_SECRET=${{ secrets.SIMKL_SECRET }}" > .env

      - name: Build
        run: |
          flutter pub get
          flutter build linux

      - name: Archive
        uses: thedoctor0/zip-release@master
        with:
          type: "zip"
          filename: Dartotsu_Linux_${{ needs.setup.outputs.version }}.zip
          directory: build/linux/x64/release/bundle

      - name: Upload to Google Drive
        id: upload
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build/linux/x64/release/bundle/Dartotsu_Linux_${{ needs.setup.outputs.version }}.zip
          upload-name: Dartotsu_linux.zip
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload to GitHub Release
        if: needs.setup.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: build/linux/x64/release/bundle/*.zip
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}

  build_ios:
    needs: setup
    if: needs.setup.outputs.should_build_ios == 'true'
    runs-on: macos-latest
    outputs:
      ipa_link: ${{ steps.upload.outputs.web-content-link }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        if: needs.setup.outputs.is_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
            .dart_tool
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Setup environment
        run: echo "SIMKL_SECRET=${{ secrets.SIMKL_SECRET }}" > .env

      - name: Build
        run: |
          flutter pub get
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          rm -rf Payload
          mkdir -p Payload
          cp -R Runner.app Payload/
          zip -r Dartotsu-iOS-${{ needs.setup.outputs.version }}.ipa Payload

      - name: Upload to Google Drive
        id: upload
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build/ios/iphoneos/Dartotsu-iOS-${{ needs.setup.outputs.version }}.ipa
          upload-name: Dartotsu-iOS.ipa
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload to GitHub Release
        if: needs.setup.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: build/ios/iphoneos/*.ipa
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}

  build_macos:
    needs: setup
    if: needs.setup.outputs.should_build_macos == 'true'
    runs-on: macos-latest
    outputs:
      dmg_link: ${{ steps.upload.outputs.web-content-link }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache dependencies
        if: needs.setup.outputs.is_clean != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
            .dart_tool
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Setup environment
        run: echo "SIMKL_SECRET=${{ secrets.SIMKL_SECRET }}" > .env

      - name: Build
        run: |
          flutter pub get
          flutter build macos --release
          mkdir -p build/macos/Release
          hdiutil create -volname "Dartotsu" -srcfolder build/macos/Build/Products/Release/Dartotsu.app -ov -format UDZO build/macos/Release/Dartotsu-macos-${{ needs.setup.outputs.version }}.dmg

      - name: Upload to Google Drive
        id: upload
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: build/macos/Release/Dartotsu-macos-${{ needs.setup.outputs.version }}.dmg
          upload-name: Dartotsu-macos.dmg
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: ${{ secrets.GOOGLE_KEY }}
          overrwrite: true

      - name: Upload to GitHub Release
        if: needs.setup.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: build/macos/Release/*.dmg
          prerelease: ${{ needs.setup.outputs.is_beta == 'true' }}

  notify_discord:
    needs: [setup, build_android, build_windows, build_linux, build_ios, build_macos]
    if: |
      always() && 
      !contains(needs.*.result, 'failure') && 
      !contains(needs.*.result, 'cancelled') &&
      (needs.build_android.result == 'success' ||
       needs.build_windows.result == 'success' ||
       needs.build_linux.result == 'success' ||
       needs.build_ios.result == 'success' ||
       needs.build_macos.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit history
        id: commits
        run: |
          if [ -f last_sha.txt ]; then
            LAST_SHA=$(cat last_sha.txt)
          else
            LAST_SHA=$(git rev-list --max-parents=0 HEAD)
          fi
          
          COMMIT_LOGS=$(git log $LAST_SHA..HEAD --pretty=format:"â— %s ~%an [Ö](https://github.com/${{ github.repository }}/commit/%H)" --max-count=10)
          COMMIT_LOGS="${COMMIT_LOGS//'%'/'%25'}"
          COMMIT_LOGS="${COMMIT_LOGS//$'\n'/'%0A'}"
          COMMIT_LOGS="${COMMIT_LOGS//$'\r'/'%0D'}"
          echo "COMMIT_LOG=${COMMIT_LOGS}" >> $GITHUB_ENV
          echo "${{ github.sha }}" > last_sha.txt
          # Debugging: Print the variable to check its content
          echo "$COMMIT_LOGS"
          echo "$COMMIT_LOGS" > commit_log.txt
          # Extract branch name from github.ref
          BRANCH=${{ github.ref }}
          BRANCH=${BRANCH#refs/heads/}
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
        shell: /usr/bin/bash -e {0}
        env:
          CI: true
        continue-on-error: true

      - name: Save Current SHA for Next Run
        run: echo ${{ github.sha }} > last_sha.txt

      - name: Check for Ping
        id: check_noping
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"[Ping]"* ]]; then
            echo "ping_variable=<@&1324799528255225997>" >> $GITHUB_ENV
          else
            echo "ping_variable=noPing" >> $GITHUB_ENV
          fi
      - name: Upload APK to Discord
        shell: bash
        run: |
          # Prepare Discord embed
          fetch_user_details() {
            local login=$1
            user_details=$(curl -s "https://api.github.com/users/$login")
            name=$(echo "$user_details" | jq -r '.name // .login')
            login=$(echo "$user_details" | jq -r '.login')
            avatar_url=$(echo "$user_details" | jq -r '.avatar_url')
            echo "$name|$login|$avatar_url"
          }

          # Additional information for the goats
          declare -A additional_info
          additional_info["ibo"]="\n Discord: <@951737931159187457>\n AniList: [takarealist112](<https://anilist.co/user/5790266/>)"
          additional_info["aayush262"]="\n Discord: <@918825160654598224>\n AniList: [aayush262](<https://anilist.co/user/5144645/>)"
          additional_info["Ankit Grai"]="\n Discord: <@1125628254330560623>\n AniList: [bheshnarayan](<https://anilist.co/user/6417303/>)\n X: [grayankit01](<https://x.com/grayankit01>)"
          additional_info["Shebyyy"]="\n Discord: <@612532963938271232>\n AniList: [ASheby](<https://anilist.co/user/5724017/>)"
          # Decimal color codes for contributors
          declare -A contributor_colors
          default_color="#1ac4c5"
          contributor_colors["aayush262"]="#5d689d"
          contributor_colors["Sadwhy"]="#ff7e95"
          contributor_colors["grayankit"]="#c51aa1"
          contributor_colors["rebelonion"]="#d4e5ed"
          contributor_colors["Shebyyy"]="#5d689d"
          hex_to_decimal() { printf '%d' "0x${1#"#"}"; }

          # Count recent commits and create an associative array
          declare -A recent_commit_counts
          echo "Debug: Processing COMMIT_LOG:"
          echo "$COMMIT_LOG"
          while read -r count name; do
              recent_commit_counts["$name"]=$count
              echo "Debug: Commit count for $name: $count"
          done < <(echo "$COMMIT_LOG" | sed 's/%0A/\n/g' | grep -oP '(?<=~)[^[]*' | sort | uniq -c | sort -rn)

          echo "Debug: Fetching contributors from GitHub"
          # Fetch contributors from GitHub
          contributors=$(curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{github.repository}}/contributors)
          echo "Debug: Contributors response:"
          echo "$contributors"

          # Create a sorted list of contributors based on recent commit counts
          sorted_contributors=$(for login in $(echo "$contributors" | jq -r '.[].login'); do
              user_info=$(fetch_user_details "$login")
              name=$(echo "$user_info" | cut -d'|' -f1)
              count=${recent_commit_counts["$name"]:-0}
              echo "$count|$login"
          done | sort -rn | cut -d'|' -f2)

          # Initialize needed variables
          developers=""
          committers_count=0
          max_commits=0
          top_contributor=""
          top_contributor_count=0
          top_contributor_avatar=""
          embed_color=$(hex_to_decimal "$default_color")

          # Process contributors in the new order
          while read -r login; do
            user_info=$(fetch_user_details "$login")
            name=$(echo "$user_info" | cut -d'|' -f1)
            login=$(echo "$user_info" | cut -d'|' -f2)
            avatar_url=$(echo "$user_info" | cut -d'|' -f3)

          # Only process if they have recent commits
          commit_count=${recent_commit_counts["$name"]:-0}
          if [ $commit_count -gt 0 ]; then
            # Update top contributor information
            if [ $commit_count -gt $max_commits ]; then
              max_commits=$commit_count
              top_contributors=("$login")
              top_contributor_count=1
              top_contributor_avatar="$avatar_url"
              embed_color=$(hex_to_decimal "${contributor_colors[$name]:-$default_color}")
            elif [ $commit_count -eq $max_commits ]; then
              top_contributors+=("$login")
              top_contributor_count=$((top_contributor_count + 1))
              embed_color=$(hex_to_decimal "$default_color")
            fi
            echo "Debug top contributors:"
            echo "$top_contributors"


            # Get commit count for this contributor on the main branch
            branch_commit_count=$(git log --author="$login" --author="$name" --oneline | awk '!seen[$0]++' | wc -l)

            # Debug: Print recent_commit_counts
            echo "Debug: recent_commit_counts contents:"
            for key in "${!recent_commit_counts[@]}"; do
              echo "$key: ${recent_commit_counts[$key]}"
            done

            extra_info="${additional_info[$name]}"
            if [ -n "$extra_info" ]; then
              extra_info=$(echo "$extra_info" | sed 's/\\n/\n- /g')
            fi

            # Construct the developer entry
            developer_entry="â—— **${name}** ${extra_info}
          - Github: [${login}](https://github.com/${login})
          - Commits: ${branch_commit_count}"


      - name: Upload SHA artifact
        uses: actions/upload-artifact@v4
        with:
          name: last-sha
          path: last_sha.txt

      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CHANNEL_ID: ${{ needs.setup.outputs.discord_channel }}
          PING_ROLE: ${{ needs.setup.outputs.ping_role }}
          VERSION: ${{ needs.setup.outputs.version }}
          IS_RELEASE: ${{ needs.setup.outputs.is_release }}
          IS_BETA: ${{ needs.setup.outputs.is_beta }}
        run: |
          # Build download links
          DOWNLOADS=""
          [[ -n "${{ needs.build_android.outputs.apk_link }}" ]] && DOWNLOADS+="[ðŸ“± Android APK](https://drive.google.com/drive/folders/1S4QzdKz7ZofhiF5GAvjMdBvYK7YhndKM)\n"
          [[ -n "${{ needs.build_windows.outputs.installer_link }}" ]] && DOWNLOADS+="[ðŸªŸ Windows Installer](${{ needs.build_windows.outputs.installer_link }})\n"
          [[ -n "${{ needs.build_linux.outputs.zip_link }}" ]] && DOWNLOADS+="[ðŸ§ Linux ZIP](${{ needs.build_linux.outputs.zip_link }})\n"
          [[ -n "${{ needs.build_ios.outputs.ipa_link }}" ]] && DOWNLOADS+="[ðŸŽ iOS IPA](${{ needs.build_ios.outputs.ipa_link }})\n"
          [[ -n "${{ needs.build_macos.outputs.dmg_link }}" ]] && DOWNLOADS+="[ðŸ’» macOS DMG](${{ needs.build_macos.outputs.dmg_link }})\n"

          # Determine title
          if [[ "$IS_RELEASE" == "true" ]]; then
            if [[ "$IS_BETA" == "true" ]]; then
              TITLE="ðŸ§ª New Beta Release - v$VERSION"
            else
              TITLE="ðŸŽ‰ New Stable Release - v$VERSION"
            fi
          else
            TITLE="ðŸ”¥ New Alpha Build"
          fi

          # Send notification
          curl -H "Content-Type: application/json" -d "{
            \"content\": \"$PING_ROLE\",
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DOWNLOADS\",
              \"color\": 1753341,
              \"fields\": [{
                \"name\": \"Recent Changes\",
                \"value\": \"$(echo "$COMMIT_LOG" | sed 's/%0A/\\n/g')\"
              }],
              \"footer\": {\"text\": \"Version $VERSION\"},
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
            }]
          }" "$WEBHOOK_URL"
